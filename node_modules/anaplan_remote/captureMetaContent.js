const fs = require('fs'),
	path = require('path'),
	htmlToJson = require('html-to-json'),
	captureImages = require('./captureImages'),
	printModel = require('./printModel'),
	panelObj = require('./panelObj'),
	printImages = require('./printImages'),
	printProvider = require('./printProvider'),
	errHandling = require('./errHandling'),
	request = require('request');

const scrape = require('html-metadata');

let modifiedScrapeLoop = ( url, print, num, tries, mod, tites ) => {
	scrape(url, (err, metadata) => {
		if ( err ) {
			console.log(err);
		}
		if ( typeof metadata.openGraph === "undefined" || metadata.openGraph === undefined ) {
			console.log('metadata undefined');
			console.log(url);
			return false;
		}
      	let fileName = 'file_' + mod + num;
    	let newDir = path.join( print, fileName + "/" );
    	let taxonomy = "[" + errHandling(metadata.openGraph.taxonomy) + "]";
    	let publish = errHandling(metadata.openGraph.published_time, 'date');
    	let modified = errHandling(metadata.openGraph.modified_time, 'date');
    	let newArr = [];
    	if ( publish === '' || modified === '' ) {
    		console.log(`
    			*****
    			publish or modified === ''
    			*****
    			`);
    		console.log(url);
    		tries++;
    		if ( tries < 4 ) {
    			modifiedScrapeLoop(url, print, num, tries, tites);
    		}
    	} else {
	    	newArr.push(tites,url,JSON.stringify(taxonomy),publish,modified);
	    	console.log(url + "\n" + modified);
	    	let thisPrint = newArr;
			let newDir = path.join( print, fileName + "/" );
			fs.writeFile(print + fileName + '.csv', thisPrint, ( err ) => {
				if ( err ) {
					console.log(err);
				}
				console.log(fileName + '.html has been added to ' + print);
			});
    	}
	});
};

let captureMetaContent = ( url, print, num, failed, mod, tites ) => {
	tites = tites.replace(/\,/, '&#44;');
	let pass;
	request(url, (err, res, body) => {
		if ( err ) {
			console.log( err );
		}
		if ( typeof res === 'undefined') {
			return false;
		}
		( res.statusCode === 200 ) ? pass = true:pass = false;
		console.log(res.statusCode + "\nPass: " + pass);
		if ( pass === true ) {
			modifiedScrapeLoop(url, print, num, 1, mod, tites);
		} else {
			let fileName = 'failed_' + mod + num;
			fs.writeFile(failed + fileName + '.csv', JSON.stringify(url), ( err ) => {
				if ( err ) {
					console.log(err);
				}
				console.log(fileName + '.csv has been added to ' + failed);
			});
		}
	});
};

module.exports = captureMetaContent;